/*
Functions for executing and checking vulnerabilities.
*/

Vulnerability = {}

/*
Executes an exploit and returns the result.

This function ain't and fails pretty badly on number-based attacks. Oh well.
*/
Vulnerability.Execute = function(metalib, address, unsafe_value, args="123")

	if not (metalib and address and unsafe_value) then
		print("Missing required arguments")
		return
	end if

	print("Executing exploit on " + address + " with " + metalib.lib_name + " " + metalib.version)

	result = metalib.overflow(address, unsafe_value)
	if typeof(result) == "number" and result == 0 then
		result = metalib.overflow(address, unsafe_value, args)
	end if

	return result
end function

/*
Checks the permissions level of a vulnerability result.
*/
Vulnerability.GetPermissions = function(exploit_result)

	result_type = typeof(exploit_result)
	if result_type == "number" or result_type == "null" then return null

	root_file = null
	remote_computer = null

	if result_type == "shell" then
		remote_computer = exploit_result.host_computer
	else if result_type == "computer" then
		remote_computer = exploit_result
	end if

	if remote_computer then root_file = remote_computer.File("/")

	if result_type == "file" then
		while exploit_result.path != "/"
			exploit_result = exploit_result.parent
		end while
		root_file = exploit_result
	end if

	remote_user = "guest"

	for folder in root_file.get_folders
		if folder.path == "/root" then
			if folder.has_permission("w") then
				remote_user = "root"
				return remote_user
			end if
		end if
		if folder.path == "/home" then
			for user_folder in folder.get_folders
				if user_folder.has_permission("w") then
					remote_user = user_folder.name
					return remote_user
				end if
			end for
		end if
	end for

	return remote_user
end function